rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSigned() {
      return request.auth.uid != null;
    }

    function isAuthor(userId) {
      return isSigned() && request.auth.uid == userId;
    }

    function isOwnDeck(deckId) {
      return exists(/databases/$(database)/documents/decks/$(request.auth.uid)/userDecks/$(deckId));
    }

    function isSharedDeck() {
      return exists(/databases/$(database)/documents/deckCollaborators/$(resource.data.deckId)/deckCollaborators/$(request.auth.uid));
    }

    function statsSharedWith(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)/collaborators/$(request.auth.uid));
    }

    match /users/{userId} {
      allow read, write: if isSigned() 
                            && (request.auth.uid == userId
                               || exists(/databases/$(database)/documents/users/$(userId)/grantedStatsAccess/$(request.auth.uid))
                               || statsSharedWith(userId));
      allow create: if request.auth.uid != null && request.auth.uid == userId;

      match /collaborators/{collaboratorId} {
        allow read: if request.auth.uid != null 
                      && (request.auth.uid == userId || request.auth.uid == collaboratorId);
        allow write: if request.auth.uid != null && request.auth.uid == userId;
      }
      
      match /grantedStatsAccess/{grantorId} {
        allow read: if isSigned()
                      && (request.auth.uid == userId || request.auth.uid == grantorId);
        allow write: if isSigned() && request.auth.uid == grantorId;
      }
    }
    
    // Email-to-uid mapping collection
    match /emailToUid/{hashedEmail} {
      // Allow read (get) only if authenticated
      allow get: if isSigned();

      // Only allow Cloud Functions to write to this collection
      allow create, update, delete: if isCloudFunction() 
                                   || (request.auth.uid != null && request.auth.uid == request.resource.data.uid);
    }

    // `collaborators` collection connect users. Records can be created by any user but the creating user's ID needs to
    // reflected in `initiatorUserId` field. User can modify the record either when their ID is `initiatorUserId` or
    // `receivingUserId`. The same rule applies to querying - user ID needs to be in either `initiatorUserId` or 
    // `receivingUserId` fields.
    match /collaborators/{invitation} {
      allow create: if request.auth.uid != null 
                       && request.resource.data.initiatorUserId == request.auth.uid;
      allow delete: if request.auth.uid != null 
                    && resource.data.initiatorUserId == request.auth.uid;
      allow update: if request.auth.uid != null
                    && (request.auth.uid == resource.data.initiatorUserId || request.auth.token.email == resource.data.receivingUserEmail)
                    && (request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['receivingUserId', 'status', 'lastChangeTimestamp']));
      allow read: if request.auth.uid != null
                  && (resource.data.initiatorUserId == request.auth.uid 
                      || resource.data.receivingUserId == request.auth.uid
                      || resource.data.receivingUserEmail == request.auth.token.email);
    }

    match /cards/{userId}/userCards/{cardId=**} {
        allow read, write: if isSigned() && (resource == null || isAuthor(userId));
        allow create: if isAuthor(userId);
    }

    match /decks/{userId}/userDecks/{deckId} {
      allow read, write: if isAuthor(userId);
      allow create: if isAuthor(userId);
    }

    match /deckCollaborators/{deckId=**} {
      allow read: if isSigned(); // && isOwnDeck(deckId);
      // allow write for deck owners so that they can share their decks with other users
      allow write: if isSigned();
    }

    match /reviewLog/{userId}/userReviewLog/{logId=**} {
      allow read: if (isAuthor(userId) || statsSharedWith(userId));
      allow write: if isAuthor(userId);
    }

    match /cardStats/{userId}/userCardStats/{cardStatId=**} {
      allow read: if (resource == null || isAuthor(userId)
                             || statsSharedWith(userId));
      allow write: if isAuthor(userId);
      allow create: if isAuthor(userId);
    }

  }
}