rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSigned() {
      return request.auth.uid != null;
    }

    function isAuthor() {
      return isSigned() && resource.data.userId == request.auth.uid;
    }

    function isOwnDeck(deckId) {
      return get(/databases/$(database)/documents/decks/$(deckId)).data.userId == request.auth.uid;
    }

    function isSharedDeck() {
      return exists(/databases/$(database)/documents/sharedDecks/$(resource.data.deckId)/collaborators/$(request.auth.uid));
    }

    function statsSharedWith() {
      return exists(/databases/$(database)/documents/users/$(resource.data.userId)/collaborators/$(request.auth.uid))
             && get(/databases/$(database)/documents/users/$(resource.data.userId)/collaborators/$(request.auth.uid)).data.stats == true;
    }

    match /users/{userId} {
      allow read, write: if isSigned() 
                            && (request.auth.uid == userId
                               || exists(/databases/$(database)/documents/users/$(userId)/grantedStatsAccess/$(request.auth.uid))
                               || exists(/databases/$(database)/documents/users/$(userId)/collaborators/$(request.auth.uid)));
      allow create: if request.auth.uid != null && request.auth.uid == userId;

      match /collaborators/{collaboratorId} {
        allow read: if request.auth.uid != null 
                      && (request.auth.uid == userId || request.auth.uid == collaboratorId);
        allow write: if request.auth.uid != null && request.auth.uid == userId;
      }
      
      match /grantedStatsAccess/{grantorId} {
        allow read: if request.auth.uid != null 
                      && (request.auth.uid == userId || request.auth.uid == grantorId);
        allow write: if request.auth.uid != null && request.auth.uid == grantorId;
      }
    }
    
    // Email-to-uid mapping collection
    match /emailToUid/{hashedEmail} {
      // Allow read (get) only if authenticated
      allow get: if isSigned();

      // Only allow Cloud Functions to write to this collection
      allow create, update, delete: if isCloudFunction() 
                                   || (request.auth.uid != null && request.auth.uid == request.resource.data.uid);
    }

    // `collaborators` collection connect users. Records can be created by any user but the creating user's ID needs to
    // reflected in `initiatorUserId` field. User can modify the record either when their ID is `initiatorUserId` or
    // `receivingUserId`. The same rule applies to querying - user ID needs to be in either `initiatorUserId` or 
    // `receivingUserId` fields.
    match /collaborators/{invitation} {
      allow create: if request.auth.uid != null 
                       && request.resource.data.initiatorUserId == request.auth.uid;
      allow delete: if request.auth.uid != null 
                    && resource.data.initiatorUserId == request.auth.uid;
      allow update: if request.auth.uid != null
                    && (request.auth.uid == resource.data.initiatorUserId || request.auth.token.email == resource.data.receivingUserEmail)
                    && (request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['receivingUserId', 'status', 'lastChangeTimestamp']));
      allow read: if request.auth.uid != null
                  && (resource.data.initiatorUserId == request.auth.uid 
                      || resource.data.receivingUserId == request.auth.uid
                      || resource.data.receivingUserEmail == request.auth.token.email);
    }

    match /cards/{card} {
      allow read, write: if isSigned() && (resource == null || request.auth.uid == resource.data.userId);
      allow create: if isSigned() && isAuthor();
    }

    match /decks/{deck} {
      allow read, write: if isSigned() && isAuthor();
      allow create: if isSigned() && isAuthor();
    }

    match /sharedDecks/{deckId} {
      allow read: if isSigned() && (request.auth.uid == resource.data.ownerUserId || request.auth.uid == resource.data.sharedWithUserId);
      // allow write for deck owners so that they can share their decks with other users
      allow write: if isSigned() && isOwnDeck(deckId) && request.auth.uid == resource.data.ownerUserId;
    }

    match /cardAnswers/{cardAnswer} {
      allow read: if isSigned() && (isAuthor() || statsSharedWith());
      allow write: if isSigned() && isAuthor();
    }

    match /cardStats/{cardStat} {
      allow read: if isSigned()
                         && (resource == null || isAuthor()
                             || (
                             	exists(/databases/$(database)/documents/users/$(resource.data.userId)/collaborators/$(request.auth.uid))
                             	&& get(/databases/$(database)/documents/users/$(resource.data.userId)/collaborators/$(request.auth.uid)).data.stats == true)
                             );
      allow write: if isSigned() && isAuthor();
      allow create: if isSigned() && isAuthor();
    }

    match /reviewLog/{reviewLog} {
      allow read: if isSigned()
                         && (request.auth.uid == resource.data.userId
                             || get(/databases/$(database)/documents/users/$(resource.data.userId)/collaborators/$(request.auth.uid)).data.stats == true);
      allow write: if isSigned() && isAuthor();
    }

  }
}